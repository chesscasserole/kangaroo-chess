<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multiplayer Chess with Piece Swap</title>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            gap: 20px;
        }
        .main-content {
            flex: 1;
            text-align: center;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(8, 60px);
            grid-template-rows: repeat(8, 60px);
            border: 2px solid #333;
            margin: 20px auto;
            position: relative;
        }
        .square {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            cursor: pointer;
            user-select: none;
        }
        .light { background-color: #f0d9b5; }
        .dark { background-color: #b58863; }
        .selected { background-color: #ffff00 !important; }
        .valid-move { background-color: #90EE90 !important; }
        .check { background-color: #ff4444 !important; }
        
        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 10px;
            height: fit-content;
        }
        .room-setup {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .room-setup input, .room-setup button {
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            box-sizing: border-box;
        }
        .room-setup button {
            background: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .room-setup button:hover { background: #45a049; }
        
        .game-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .status {
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
        }
        .room-id {
            background: #e7e7e7;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 16px;
        }
        
        .chat {
            background: white;
            border-radius: 10px;
            height: 300px;
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .chat-input {
            display: flex;
            padding: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
        .chat-input button {
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            margin-left: 5px;
            cursor: pointer;
        }
        
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        .message.white { background: #f0f8ff; }
        .message.black { background: #f5f5f5; }
        .message.spectator { background: #fff5ee; }
        
        .hidden { display: none !important; }
        .game-over { color: red; font-size: 20px; }
        
        .controls {
            margin: 15px 0;
        }
        .controls button {
            padding: 8px 15px;
            margin: 0 5px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .controls button:hover { background: #1976D2; }
        
        .player-info {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        .player {
            padding: 10px;
            border-radius: 5px;
            flex: 1;
            margin: 0 5px;
        }
        .player.white { background: #f0f8ff; }
        .player.black { background: #333; color: white; }
        .player.active { border: 3px solid #4CAF50; }
        .player.disconnected { opacity: 0.5; }
    </style>
</head>
<body>
    <div class="container">
        <div class="main-content">
            <h1>Multiplayer Chess with Piece Swap</h1>
            
            <div id="room-setup" class="room-setup">
                <h3>Join or Create Game</h3>
                <input type="text" id="playerName" placeholder="Enter your name" maxlength="20">
                <button onclick="createRoom()">Create New Game</button>
                <div style="text-align: center; margin: 10px 0;">- OR -</div>
                <input type="text" id="roomCode" placeholder="Enter room code" maxlength="6">
                <button onclick="joinRoom()">Join Game</button>
            </div>
            
            <div id="game-container" class="hidden">
                <div class="game-info">
                    <div class="player-info">
                        <div class="player white" id="white-player">
                            <div><strong>White</strong></div>
                            <div id="white-name">Waiting...</div>
                        </div>
                        <div class="player black" id="black-player">
                            <div><strong>Black</strong></div>
                            <div id="black-name">Waiting...</div>
                        </div>
                    </div>
                    <div class="status" id="status">Waiting for opponent...</div>
                    <div>Room Code: <span class="room-id" id="room-id"></span></div>
                </div>
                
                <div class="controls">
                    <button onclick="requestRematch()" id="rematch-btn" class="hidden">Request Rematch</button>
                    <button onclick="leaveGame()">Leave Game</button>
                    <button onclick="toggleSound()" id="sound-btn">Sound: ON</button>
                </div>
                
                <div class="board" id="board"></div>
                
                <div class="instructions">
                    <p><strong>How to play:</strong></p>
                    <p>Normal moves: Click piece → Click destination</p>
                    <p>Piece swap: Click your piece → Click another of your pieces</p>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div id="waiting-sidebar">
                <h3>Waiting for game...</h3>
                <p>Share your room code with a friend to start playing!</p>
            </div>
            
            <div id="game-sidebar" class="hidden">
                <div class="chat">
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input">
                        <input type="text" id="chat-input" placeholder="Type message..." maxlength="100">
                        <button onclick="sendMessage()">Send</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Socket connection
        const socket = io();
        
        // Game state
        let gameState = {
            board: null,
            currentPlayer: 'white',
            myColor: null,
            roomId: null,
            playerName: '',
            selectedSquare: null,
            gameOver: false,
            soundEnabled: true
        };

        // Audio for sound effects
        let audioContext = null;
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        function playSound(freq, duration, type = 'sine') {
            if (!gameState.soundEnabled || !audioContext) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.value = freq;
            osc.type = type;
            gain.gain.setValueAtTime(0.1, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            osc.start(audioContext.currentTime);
            osc.stop(audioContext.currentTime + duration);
        }

        // Chess pieces
        const pieceSymbols = {
            'K': '♔', 'Q': '♕', 'R': '♖', 'B': '♗', 'N': '♘', 'P': '♙',
            'k': '♚', 'q': '♛', 'r': '♜', 'b': '♝', 'n': '♞', 'p': '♟'
        };

        // UI Functions
        function createRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            if (!playerName) {
                alert('Please enter your name');
                return;
            }
            gameState.playerName = playerName;
            socket.emit('create-room', playerName);
        }

        function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim().toUpperCase();
            
            if (!playerName || !roomCode) {
                alert('Please enter both name and room code');
                return;
            }
            
            gameState.playerName = playerName;
            socket.emit('join-room', { roomId: roomCode, playerName: playerName });
        }

        function leaveGame() {
            location.reload();
        }

        function toggleSound() {
            gameState.soundEnabled = !gameState.soundEnabled;
            document.getElementById('sound-btn').textContent = `Sound: ${gameState.soundEnabled ? 'ON' : 'OFF'}`;
            if (gameState.soundEnabled) initAudio();
        }

        function requestRematch() {
            socket.emit('request-rematch');
            document.getElementById('rematch-btn').textContent = 'Rematch Requested...';
            document.getElementById('rematch-btn').disabled = true;
        }

        function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (message) {
                socket.emit('chat-message', message);
                input.value = '';
            }
        }

        // Allow Enter key in chat
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        // Game Functions
        function showGame(roomId, color) {
            document.getElementById('room-setup').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            document.getElementById('waiting-sidebar').classList.add('hidden');
            document.getElementById('game-sidebar').classList.remove('hidden');
            
            gameState.roomId = roomId;
            gameState.myColor = color;
            document.getElementById('room-id').textContent = roomId;
            
            updatePlayerInfo();
        }

        function updatePlayerInfo() {
            const whitePlayer = document.getElementById('white-player');
            const blackPlayer = document.getElementById('black-player');
            
            // Update active player indicator
            document.querySelectorAll('.player').forEach(p => p.classList.remove('active'));
            document.getElementById(`${gameState.currentPlayer}-player`).classList.add('active');
        }

        function createBoard() {
            const boardElement = document.getElementById('board');
            boardElement.innerHTML = '';
            
            if (!gameState.board) return;

            // Flip board for black player
            const isFlipped = gameState.myColor === 'black';

            for (let row = 0; row < 8; row++) {
                for (let col = 0; col < 8; col++) {
                    const displayRow = isFlipped ? 7 - row : row;
                    const displayCol = isFlipped ? 7 - col : col;
                    
                    const square = document.createElement('div');
                    square.className = `square ${(row + col) % 2 === 0 ? 'light' : 'dark'}`;
                    square.dataset.row = displayRow;
                    square.dataset.col = displayCol;
                    square.onclick = () => handleSquareClick(displayRow, displayCol);
                    
                    const piece = gameState.board[displayRow][displayCol];
                    if (piece) {
                        square.textContent = pieceSymbols[piece];
                    }
                    
                    // Highlight selected square
                    if (gameState.selectedSquare && 
                        gameState.selectedSquare.row === displayRow && 
                        gameState.selectedSquare.col === displayCol) {
                        square.classList.add('selected');
                    }
                    
                    // Show valid moves
                    if (gameState.selectedSquare && canMakeMove(gameState.selectedSquare.row, gameState.selectedSquare.col, displayRow, displayCol)) {
                        square.classList.add('valid-move');
                    }
                    
                    boardElement.appendChild(square);
                }
            }
        }

        function handleSquareClick(row, col) {
            if (gameState.gameOver || gameState.currentPlayer !== gameState.myColor) {
                return;
            }

            if (gameState.selectedSquare === null) {
                // First click - select piece
                const piece = gameState.board[row][col];
                if (piece && isMyPiece(piece)) {
                    gameState.selectedSquare = { row, col };
                    createBoard();
                }
            } else {
                // Second click - make move
                const fromRow = gameState.selectedSquare.row;
                const fromCol = gameState.selectedSquare.col;
                
                if (row === fromRow && col === fromCol) {
                    // Deselect
                    gameState.selectedSquare = null;
                    createBoard();
                    return;
                }
                
                makeMove(fromRow, fromCol, row, col);
            }
        }

        function makeMove(fromRow, fromCol, toRow, toCol) {
            const piece = gameState.board[fromRow][fromCol];
            const targetPiece = gameState.board[toRow][toCol];
            
            // Check if this is a piece swap
            if (targetPiece && isMyPiece(targetPiece) && isMyPiece(piece)) {
                // Piece swap
                socket.emit('make-move', {
                    type: 'swap',
                    from: { row: fromRow, col: fromCol, piece },
                    to: { row: toRow, col: toCol, piece: targetPiece }
                });
                playSound(600, 0.15, 'triangle');
            } else if (canMakeMove(fromRow, fromCol, toRow, toCol)) {
                // Normal move
                socket.emit('make-move', {
                    type: 'move',
                    from: { row: fromRow, col: fromCol },
                    to: { row: toRow, col: toCol },
                    piece: piece,
                    captured: targetPiece
                });
                
                if (targetPiece) {
                    playSound(400, 0.2, 'square'); // Capture sound
                } else {
                    playSound(800, 0.1); // Move sound
                }
            }
            
            gameState.selectedSquare = null;
        }

        function canMakeMove(fromRow, fromCol, toRow, toCol) {
            const piece = gameState.board[fromRow][fromCol];
            const targetPiece = gameState.board[toRow][toCol];
            
            // Basic validation (simplified for multiplayer)
            if (!piece || !isMyPiece(piece)) return false;
            if (targetPiece && isMyPiece(targetPiece)) return false; // Can't capture own piece (unless swapping)
            if (fromRow === toRow && fromCol === toCol) return false;
            
            return true; // Let server validate detailed rules
        }

        function isMyPiece(piece) {
            if (gameState.myColor === 'white') {
                return piece === piece.toUpperCase();
            } else {
                return piece === piece.toLowerCase();
            }
        }

        function updateStatus(message, isGameOver = false) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = isGameOver ? 'status game-over' : 'status';
        }

        function addChatMessage(data) {
            const messagesDiv = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${data.color}`;
            messageDiv.innerHTML = `<strong>${data.playerName}:</strong> ${data.message}`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Socket event handlers
        socket.on('room-created', (data) => {
            showGame(data.roomId, data.color);
            gameState.board = data.game.board;
            gameState.currentPlayer = data.game.currentPlayer;
            
            document.getElementById('white-name').textContent = gameState.playerName;
            updateStatus('Waiting for opponent to join...');
            createBoard();
        });

        socket.on('room-joined', (data) => {
            showGame(data.roomId, data.color);
            gameState.board = data.game.board;
            gameState.currentPlayer = data.game.currentPlayer;
            
            if (data.game.players.white) {
                document.getElementById('white-name').textContent = data.game.players.white.name;
            }
            if (data.game.players.black) {
                document.getElementById('black-name').textContent = data.game.players.black.name;
            }
            
            updatePlayerInfo();
            createBoard();
        });

        socket.on('game-start', (game) => {
            document.getElementById('white-name').textContent = game.players.white.name;
            document.getElementById('black-name').textContent = game.players.black.name;
            updateStatus("Game started! White's turn");
            updatePlayerInfo();
        });

        socket.on('move-made', (data) => {
            gameState.board = data.game.board;
            gameState.currentPlayer = data.game.currentPlayer;
            
            updateStatus(`${gameState.currentPlayer.charAt(0).toUpperCase() + gameState.currentPlayer.slice(1)}'s turn`);
            updatePlayerInfo();
            createBoard();
        });

        socket.on('game-ended', (result) => {
            gameState.gameOver = true;
            updateStatus(result, true);
            document.getElementById('rematch-btn').classList.remove('hidden');
            playSound(200, 0.5, 'sawtooth'); // Game over sound
        });

        socket.on('game-reset', (game) => {
            gameState.board = game.board;
            gameState.currentPlayer = game.currentPlayer;
            gameState.gameOver = false;
            gameState.selectedSquare = null;
            
            document.getElementById('rematch-btn').classList.add('hidden');
            document.getElementById('rematch-btn').textContent = 'Request Rematch';
            document.getElementById('rematch-btn').disabled = false;
            
            updateStatus("Game reset! White's turn");
            updatePlayerInfo();
            createBoard();
        });

        socket.on('chat-message', (data) => {
            addChatMessage(data);
        });

        socket.on('rematch-requested', (data) => {
            if (confirm(`${data.from === 'white' ? 'White' : 'Black'} player requested a rematch. Accept?`)) {
                socket.emit('accept-rematch');
            }
        });

        socket.on('player-disconnected', (data) => {
            updateStatus(`${data.color.charAt(0).toUpperCase() + data.color.slice(1)} player disconnected`);
            document.getElementById(`${data.color}-player`).classList.add('disconnected');
        });

        socket.on('error', (message) => {
            alert('Error: ' + message);
        });

        // Initialize audio on first user interaction
        document.addEventListener('click', () => {
            if (gameState.soundEnabled && !audioContext) {
                initAudio();
            }
        }, { once: true });
    </script>
</body>
</html>
